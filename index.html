<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GCTU SIP</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --secondary: #14b8a6;
      --secondary-dark: #0d9488;
      --accent: #f59e0b;
      --danger: #ef4444;
      --success: #10b981;
      --dark: #0f172a;
      --gray: #64748b;
      --light: #f8fafc;
      --border: #e2e8f0;
      --shadow: rgba(0, 0, 0, 0.1);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      min-height: 100vh;
      color: var(--dark);
      line-height: 1.6;
    }
    
    /* Login Screen */
    .login-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    
    .login-wrapper::before {
      content: '';
      position: absolute;
      width: 500px;
      height: 500px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      top: -250px;
      right: -250px;
      animation: float 20s infinite ease-in-out;
      will-change: transform;
    }
    
    .login-wrapper::after {
      content: '';
      position: absolute;
      width: 400px;
      height: 400px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      bottom: -200px;
      left: -200px;
      animation: float 15s infinite ease-in-out reverse;
      will-change: transform;
    }
    
    @keyframes float {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      50% { transform: translate(50px, 50px) rotate(180deg); }
    }
    
    .login-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      padding: 50px 45px;
      width: 100%;
      max-width: 480px;
      animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      position: relative;
      z-index: 1;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .logo {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .logo-icon {
      width: 90px;
      height: 90px;
      margin: 0 auto 24px;
      background: white;
      border-radius: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
      padding: 8px;
    }
    
    .logo-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .logo h1 {
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }
    
    .logo p {
      color: var(--gray);
      font-size: 15px;
      font-weight: 500;
    }
    
    .form-group {
      margin-bottom: 24px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--dark);
      font-size: 14px;
      letter-spacing: 0.3px;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 16px 18px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 15px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
      font-weight: 500;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      transform: translateY(-2px);
    }
    
    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      letter-spacing: 0.5px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(99, 102, 241, 0.4);
    }
    
    .btn-primary:active {
      transform: translateY(-1px);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .alert {
      padding: 14px 18px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      font-weight: 500;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .alert-error {
      background: #fee;
      color: var(--danger);
      border: 2px solid #fcc;
    }
    
    .alert-success {
      background: #d1fae5;
      color: var(--success);
      border: 2px solid #86efac;
    }
    
    /* Main App */
    .app-wrapper {
      display: none;
    }
    
    .app-wrapper.active {
      display: block;
    }
    
    .header {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(20px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--border);
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-title {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .header-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }
    
    .header-actions {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .btn-logout {
      padding: 10px 24px;
      background: linear-gradient(135deg, var(--danger), #dc2626);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .btn-logout:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }
    
    .hamburger {
      display: none;
      flex-direction: column;
      gap: 5px;
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    .hamburger:hover {
      background: var(--light);
    }
    
    .hamburger span {
      width: 28px;
      height: 3px;
      background: var(--dark);
      border-radius: 3px;
      transition: all 0.3s;
    }
    
    .navbar {
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .navbar-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 32px;
      display: flex;
      gap: 8px;
    }
    
    .nav-item {
      padding: 18px 28px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      font-weight: 600;
      color: var(--gray);
      position: relative;
    }
    
    .nav-item::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: all 0.3s;
      transform: translateX(-50%);
    }
    
    .nav-item:hover {
      color: var(--primary);
      background: linear-gradient(180deg, transparent, rgba(99, 102, 241, 0.05));
    }
    
    .nav-item.active {
      color: var(--primary);
    }
    
    .nav-item.active::after {
      width: 100%;
    }
    
    .main-content {
      max-width: 1400px;
      margin: 40px auto;
      padding: 0 32px;
    }
    
    .card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      animation: fadeIn 0.4s ease;
      border: 1px solid var(--border);
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .card-title {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .card-subtitle {
      color: var(--gray);
      font-size: 16px;
      margin-bottom: 32px;
      font-weight: 500;
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin: 32px 0;
    }
    
    .action-card {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 36px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
    
    .action-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 50px rgba(99, 102, 241, 0.4);
    }
    
    .action-card svg {
      width: 48px;
      height: 48px;
      fill: white;
      position: relative;
      z-index: 1;
    }
    
    .action-card h3 {
      font-size: 20px;
      font-weight: 700;
      position: relative;
      z-index: 1;
    }
    
    .action-card p {
      font-size: 15px;
      opacity: 0.95;
      position: relative;
      z-index: 1;
      line-height: 1.5;
    }
    
    .action-card.green {
      background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
    }
    
    .action-card.orange {
      background: linear-gradient(135deg, var(--accent), #d97706);
    }
    
    .course-list {
      margin-top: 32px;
    }
    
    .course-item {
      background: linear-gradient(135deg, var(--light), white);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 16px;
      border-left: 5px solid var(--primary);
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .course-item:hover {
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      transform: translateX(8px);
      border-left-color: var(--secondary);
    }
    
    .course-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
      gap: 16px;
    }
    
    .course-code {
      font-weight: 800;
      color: var(--primary);
      font-size: 18px;
      letter-spacing: 0.5px;
    }
    
    .course-title {
      color: var(--dark);
      margin: 8px 0;
      font-size: 16px;
      font-weight: 600;
    }
    
    .course-lecturer {
      color: var(--gray);
      font-size: 14px;
      font-weight: 500;
    }
    
    .badge {
      padding: 6px 16px;
      border-radius: 24px;
      font-size: 13px;
      font-weight: 700;
      white-space: nowrap;
    }
    
    .badge-success {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: var(--success);
    }
    
    .badge-warning {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #d97706;
    }
    
    .question-section {
      margin: 40px 0;
    }
    
    .question-category {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      padding: 18px 28px;
      border-radius: 14px;
      font-weight: 700;
      color: white;
      margin-bottom: 24px;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
      font-size: 16px;
    }
    
    .question-item {
      margin-bottom: 32px;
      padding: 24px;
      background: var(--light);
      border-radius: 14px;
      transition: all 0.3s;
    }
    
    .question-item:hover {
      background: white;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
    
    .question-text {
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--dark);
      font-size: 16px;
      line-height: 1.6;
    }
    
    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .option {
      padding: 12px 24px;
      border: 2px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      font-weight: 600;
      font-size: 15px;
    }
    
    .option:hover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
      transform: translateY(-2px);
    }
    
    .option.selected {
      border-color: var(--primary);
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    .progress-bar {
      height: 12px;
      background: var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin: 24px 0;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
    }
    
    .summary-box {
      background: linear-gradient(135deg, var(--light), white);
      padding: 28px;
      border-radius: 16px;
      margin: 24px 0;
      border: 2px solid var(--border);
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 14px 0;
      border-bottom: 2px solid var(--border);
      font-size: 16px;
    }
    
    .summary-item:last-child {
      border-bottom: none;
    }
    
    .btn-group {
      display: flex;
      gap: 16px;
      margin-top: 32px;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, var(--gray), #475569);
      color: white;
      box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #475569, #334155);
      transform: translateY(-2px);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success), var(--secondary-dark));
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, var(--secondary-dark), #0f766e);
      transform: translateY(-2px);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #dc2626);
      color: white;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .btn-danger:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-2px);
    }
    
    .about-section {
      text-align: center;
      padding: 60px 24px;
    }
    
    .about-section h2 {
      font-size: 42px;
      margin-bottom: 16px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .about-section .developer {
      font-size: 32px;
      background: linear-gradient(135deg, var(--accent), #d97706);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
      margin: 24px 0;
    }
    
    .about-section .mission {
      font-size: 20px;
      color: var(--gray);
      max-width: 700px;
      margin: 0 auto;
      font-weight: 500;
      line-height: 1.7;
    }
    
    .link-box {
      background: linear-gradient(135deg, var(--light), white);
      padding: 28px;
      border-radius: 16px;
      text-align: center;
      margin: 32px 0;
      border: 2px solid var(--border);
    }
    
    .btn-link {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 14px 36px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-weight: 700;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    
    .btn-link:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }
    
    .hidden {
      display: none;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }
    
    .stat-card {
      background: linear-gradient(135deg, var(--light), white);
      padding: 24px;
      border-radius: 14px;
      text-align: center;
      border: 2px solid var(--border);
      transition: all 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }
    
    .stat-label {
      color: var(--gray);
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    @media (max-width: 768px) {
      .login-card {
        padding: 36px 28px;
      }
      
      .navbar-content {
        flex-direction: column;
        padding: 0;
        display: none;
      }
      
      .navbar-content.mobile-open {
        display: flex;
      }
      
      .nav-item {
        border-bottom: 1px solid var(--border);
      }
      
      .nav-item::after {
        display: none;
      }
      
      .hamburger {
        display: flex;
      }
      
      .grid {
        grid-template-columns: 1fr;
      }
      
      .header-content {
        padding: 20px;
      }
      
      .header-title {
        font-size: 18px;
      }
      
      .main-content {
        padding: 0 20px;
      }
      
      .card {
        padding: 28px 20px;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .btn-group .btn {
        width: 100%;
      }
      
      .options {
        flex-direction: column;
      }
      
      .option {
        width: 100%;
      }
    }
    
    @media print {
      @page {
        margin: 0;
        size: A4;
      }
      
      body {
        background: white;
        padding: 0;
        margin: 0;
      }
      
      .header, .navbar, .no-print {
        display: none !important;
      }
      
      .main-content {
        padding: 15mm;
        margin: 0;
      }
      
      .card {
        box-shadow: none;
        page-break-inside: avoid;
        border: none;
        padding: 0;
        margin: 0;
      }
      
      .results-card {
        padding: 0;
        margin: 0;
      }
      
      .results-table {
        page-break-inside: auto;
      }
      
      .results-table tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      
      /* Hide print header/footer completely */
      html {
        margin: 0;
        padding: 0;
      }
    }
    
    /* Custom Dialog Styles */
    .custom-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .custom-dialog {
      background: white;
      border-radius: 20px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      overflow: hidden;
    }
    
    .custom-dialog-header {
      padding: 30px 30px 20px;
      text-align: center;
    }
    
    .custom-dialog-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .custom-dialog-icon.warning {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
    }
    
    .custom-dialog-icon.error {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
    }
    
    .custom-dialog-icon.success {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    }
    
    .custom-dialog-icon.info {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
    }
    
    .custom-dialog-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--dark);
      margin: 0 0 12px 0;
    }
    
    .custom-dialog-message {
      font-size: 16px;
      color: var(--gray);
      line-height: 1.6;
      margin: 0;
      padding: 0 10px;
    }
    
    .custom-dialog-footer {
      padding: 20px 30px 30px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    
    .custom-dialog-footer .btn {
      flex: 1;
      max-width: 150px;
    }
    
    @media (max-width: 768px) {
      .custom-dialog {
        margin: 20px;
        max-width: calc(100% - 40px);
      }
      
      .custom-dialog-header {
        padding: 24px 24px 16px;
      }
      
      .custom-dialog-icon {
        width: 60px;
        height: 60px;
      }
      
      .custom-dialog-title {
        font-size: 20px;
      }
      
      .custom-dialog-message {
        font-size: 14px;
      }
      
      .custom-dialog-footer {
        padding: 16px 24px 24px;
        flex-direction: column;
      }
      
      .custom-dialog-footer .btn {
        max-width: none;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-wrapper">
    <div class="login-card">
      <div class="logo">
        <div class="logo-icon">
          <img src="https://cdn.corenexis.com/files/b/5229968168.png" alt="GCTU Logo">
        </div>
        <h1>GCTU SIP</h1>
        <p>Lecturer Evaluation System</p>
      </div>
      
      <div id="loginAlert"></div>
      
      <form id="loginForm">
        <div class="form-group">
          <label>Student ID</label>
          <input type="text" id="username" placeholder="163546746" required>
        </div>
        
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" placeholder="Enter your password" required>
        </div>
        
        <button type="submit" class="btn btn-primary" id="loginBtn">
          <span>Login to System</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div id="appScreen" class="app-wrapper">
    <div class="header">
      <div class="header-content">
        <div class="header-title">
          <img src="https://cdn.corenexis.com/files/b/5229968168.png" alt="GCTU" class="header-logo">
          GCTU SIP Evaluation
        </div>
        <div class="header-actions">
          <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <button class="btn-logout" id="logoutBtn">Logout</button>
        </div>
      </div>
    </div>
    
    <div class="navbar">
      <div class="navbar-content" id="navbar">
        <div class="nav-item active" data-view="home">Home</div>
        <div class="nav-item" data-view="evaluate">Evaluate Lecturers</div>
        <div class="nav-item" data-view="registration">Course Registration</div>
        <div class="nav-item" data-view="results">View Results</div>
        <div class="nav-item" data-view="about">About</div>
      </div>
    </div>
    
    <div class="main-content">
      <!-- Home View -->
      <div id="homeView" class="view-content">
        <div class="card">
          <h2 class="card-title" id="welcomeTitle">Welcome to GCTU SIP Evaluation</h2>
          <p class="card-subtitle">Streamline your lecturer evaluations for Academic Year 2025/2026</p>
          
          <div class="grid">
            <div class="action-card" data-action="evaluate">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
              </svg>
              <h3>Evaluate Lecturers</h3>
              <p>Evaluate all pending lecturers or select specific courses</p>
            </div>
            
            <div class="action-card" style="background: linear-gradient(135deg, #10b981, #059669);" data-action="registration">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
              <h3>Course Registration</h3>
              <p>View and register for your courses</p>
            </div>
            
            <div class="action-card" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);" data-action="results">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
              </svg>
              <h3>View Results</h3>
              <p>View and download your course results</p>
            </div>
            
            <div class="action-card orange" data-action="about">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
              </svg>
              <h3>About Developer</h3>
              <p>Learn about the creator of this system</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Evaluate All View -->
      <div id="evaluateView" class="view-content hidden"></div>
      
      <!-- Select Courses View -->
      <div id="selectView" class="view-content hidden"></div>
      
      <!-- Results View -->
      <div id="resultsView" class="view-content hidden"></div>

      <!-- Registration View -->
      <div id="registrationView" class="view-content hidden"></div>

      <!-- About View -->
      <div id="aboutView" class="view-content hidden">
        <div class="card">
          <div class="about-section">
            <h2>About Developer</h2>
            <div class="developer">TheNooB</div>
            <p class="mission">Committed to making students' lives easier through innovative solutions</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE = 'https://autoevaluate.pupujiger.workers.dev';
    let authToken = localStorage.getItem('authToken') || null;
    let evaluationQuestions = null;
    let currentCourses = [];
    let userName = localStorage.getItem('userName') || null;
    let commonAnswers = [];
    
    // Custom Dialog Functions
    function showCustomDialog(options) {
      return new Promise(function(resolve) {
        const overlay = document.createElement('div');
        overlay.className = 'custom-dialog-overlay';
        
        const iconSvg = {
          warning: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M12 9v4m0 4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>',
          error: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
          success: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>',
          info: '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
        };
        
        let buttonsHTML = '';
        if (options.buttons) {
          options.buttons.forEach(function(btn) {
            const btnClass = btn.primary ? 'btn-primary' : (btn.type === 'danger' ? 'btn-danger' : 'btn-secondary');
            buttonsHTML += '<button class="btn ' + btnClass + '" data-action="' + btn.action + '">' + btn.text + '</button>';
          });
        }
        
        overlay.innerHTML = '<div class="custom-dialog">' +
          '<div class="custom-dialog-header">' +
            '<div class="custom-dialog-icon ' + (options.type || 'info') + '">' +
              (iconSvg[options.type] || iconSvg.info) +
            '</div>' +
            '<h3 class="custom-dialog-title">' + (options.title || 'Alert') + '</h3>' +
            '<p class="custom-dialog-message">' + (options.message || '') + '</p>' +
          '</div>' +
          '<div class="custom-dialog-footer">' + buttonsHTML + '</div>' +
        '</div>';
        
        document.body.appendChild(overlay);
        
        // Add click handlers
        overlay.querySelectorAll('.btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            document.body.removeChild(overlay);
            resolve(action);
          });
        });
        
        // Click outside to close
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay) {
            document.body.removeChild(overlay);
            resolve(null);
          }
        });
      });
    }
    
    function showAlert(message, title, type) {
      return showCustomDialog({
        title: title || 'Alert',
        message: message,
        type: type || 'info',
        buttons: [{ text: 'OK', action: 'ok', primary: true }]
      });
    }
    
    function showConfirm(message, title) {
      return showCustomDialog({
        title: title || 'Confirm',
        message: message,
        type: 'warning',
        buttons: [
          { text: 'No', action: 'no', type: 'secondary' },
          { text: 'Yes', action: 'yes', primary: true }
        ]
      });
    }
    
    // Check if we have a saved token on page load
    window.addEventListener('DOMContentLoaded', function() {
      if (authToken) {
        console.log('Found saved token, checking if valid...');
        // Try to validate token by making a quick API call
        validateToken();
      }
    });
    
    async function validateToken() {
      try {
        const result = await apiCall('/components_data/academic_year_option_list', 'GET');
        if (result && !result.error) {
          console.log('Token is valid, auto-logging in...');
          loginScreen.style.display = 'none';
          appScreen.classList.add('active');
          // Fetch and display user name
          fetchAndDisplayUserName();
        } else {
          console.log('Token expired, clearing...');
          authToken = null;
          localStorage.removeItem('authToken');
        }
      } catch (error) {
        console.log('Token validation failed:', error);
        authToken = null;
        localStorage.removeItem('authToken');
      }
    }
    
    // Fetch and display user name from results
    async function fetchAndDisplayUserName() {
      if (userName) {
        // Already have cached name
        updateWelcomeMessage(userName);
        return;
      }
      
      try {
        // Try to fetch user name from results
        const result = await apiCall('/courses/results?page=1&limit=1', 'GET');
        
        if (result && result.isHtml && result.html) {
          // Parse HTML to extract name
          const parser = new DOMParser();
          const doc = parser.parseFromString(result.html, 'text/html');
          
          // Look for name in common patterns
          const namePatterns = [
            /Name:\s*([^<\n]+)/i,
            /Student Name:\s*([^<\n]+)/i,
            /<strong>Name:<\/strong>\s*([^<\n]+)/i
          ];
          
          for (let pattern of namePatterns) {
            const match = result.html.match(pattern);
            if (match && match[1]) {
              userName = match[1].trim();
              localStorage.setItem('userName', userName);
              updateWelcomeMessage(userName);
              return;
            }
          }
          
          // Try to find from table cells or divs
          const textContent = doc.body.textContent || doc.body.innerText || '';
          const nameMatch = textContent.match(/Name:\s*(.+?)(?:\n|Student ID)/i);
          if (nameMatch && nameMatch[1]) {
            userName = nameMatch[1].trim();
            localStorage.setItem('userName', userName);
            updateWelcomeMessage(userName);
          }
        }
      } catch (error) {
        console.log('Could not fetch user name:', error);
        // Not critical, just use generic greeting
      }
    }
    
    function updateWelcomeMessage(name) {
      const welcomeTitle = document.getElementById('welcomeTitle');
      if (welcomeTitle && name) {
        welcomeTitle.textContent = 'Welcome, ' + name + '!';
      }
    }

    // DOM Elements
    const loginScreen = document.getElementById('loginScreen');
    const appScreen = document.getElementById('appScreen');
    const loginForm = document.getElementById('loginForm');
    const loginAlert = document.getElementById('loginAlert');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const hamburger = document.getElementById('hamburger');
    const navbar = document.getElementById('navbar');
    const navItems = document.querySelectorAll('.nav-item');
    const viewContents = document.querySelectorAll('.view-content');

    // Show login alert (for login page)
    function showLoginAlert(message, type) {
      const alertClass = type === 'error' ? 'alert-error' : 'alert-success';
      loginAlert.innerHTML = '<div class="alert ' + alertClass + '">' + message + '</div>';
      setTimeout(function() {
        loginAlert.innerHTML = '';
      }, 5000);
    }

    // API call helper
    async function apiCall(endpoint, method, body) {
      const options = {
        method: method || 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      };

      if (authToken) {
        options.headers['Authorization'] = 'Bearer ' + authToken;
      }

      if (body) {
        options.body = JSON.stringify(body);
      }

      try {
        console.log('API Call:', API_BASE + endpoint);
        const response = await fetch(API_BASE + endpoint, options);
        console.log('Response status:', response.status, response.statusText);
        
        // Handle 401 Unauthorized - token expired
        if (response.status === 401) {
          console.error('Unauthorized - token expired or invalid');
          
          // Clear invalid token and force re-login
          authToken = null;
          localStorage.removeItem('authToken');
          
          // Show login screen with message
          loginScreen.style.display = 'flex';
          appScreen.classList.remove('active');
          showAlert('Your session has expired. Please login again.', 'Session Expired', 'warning');
          
          return null;
        }
        
        // Handle 404 for enrollment - likely not eligible
        if (response.status === 404 && endpoint.includes('/courses/enroll/')) {
          console.error('404 - Not eligible for enrollment');
          return { error: 'not_eligible' };
        }
        
        const contentType = response.headers.get('content-type');
        console.log('Content-Type:', contentType);
        
        // Check if response is JSON or HTML
        if (contentType && contentType.includes('application/json')) {
          const data = await response.json();
          console.log('JSON response:', data);
          return data;
        } else {
          // If it's HTML or other format, return as text
          const text = await response.text();
          console.log('Non-JSON response (first 200 chars):', text.substring(0, 200));
          return { html: text, isHtml: true };
        }
      } catch (error) {
        console.error('API Error:', error);
        return { error: error.message };
      }
    }

    // Login handler
    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      loginBtn.disabled = true;
      loginBtn.innerHTML = '<div class="spinner"></div><span>Logging in...</span>';

      const result = await apiCall('/auth/login', 'POST', {
        username: username,
        password: password
      });

      if (result && result.token) {
        authToken = result.token;
        localStorage.setItem('authToken', authToken);
        console.log('Login successful! Token saved:', authToken);
        loginScreen.style.display = 'none';
        appScreen.classList.add('active');
        
        // Fetch user name and show greeting
        fetchUserNameAndGreet();
      } else {
        showLoginAlert('Login failed. Please check your credentials.', 'error');
      }

      loginBtn.disabled = false;
      loginBtn.innerHTML = '<span>Login to System</span>';
    });
    
    // Fetch user name from results and show greeting
    async function fetchUserNameAndGreet() {
      try {
        // Try to fetch results to extract name
        const result = await apiCall('/courses/results?page=1&limit=10&export=print', 'GET');
        
        if (result && result.isHtml && result.html) {
          // Parse HTML to extract name
          const parser = new DOMParser();
          const doc = parser.parseFromString(result.html, 'text/html');
          
          // Look for Name: field in the HTML (common pattern: "Name: Mr/Mrs/Miss ... ")
          const nameMatch = result.html.match(/Name:\s*<\/td>\s*<td[^>]*>\s*([^<]+)/i);
          if (nameMatch && nameMatch[1]) {
            userName = nameMatch[1].trim();
            localStorage.setItem('userName', userName);
            console.log('Extracted user name:', userName);
            // Update welcome title
            updateWelcomeMessage(userName);
          }
        }
        
        // Show greeting
        if (userName) {
          await showCustomDialog({
            title: 'Welcome Back!',
            message: 'Hello ' + userName + '! Welcome to GCTU SIP Evaluation System. We\'re glad to have you here.',
            type: 'success',
            buttons: [{ text: 'Let\'s Start', action: 'ok', primary: true }]
          });
        }
      } catch (error) {
        console.log('Could not fetch user name:', error);
        // Show generic greeting if name fetch fails
        await showCustomDialog({
          title: 'Welcome Back!',
          message: 'Welcome to GCTU SIP Evaluation System. You have successfully logged in!',
          type: 'success',
          buttons: [{ text: 'Continue', action: 'ok', primary: true }]
        });
      }
    }

    // Logout handler
    logoutBtn.addEventListener('click', function() {
      authToken = null;
      userName = null;
      localStorage.removeItem('authToken');
      localStorage.removeItem('userName');
      console.log('Logged out, token cleared');
      loginScreen.style.display = 'flex';
      appScreen.classList.remove('active');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    });

    // Hamburger menu
    hamburger.addEventListener('click', function() {
      navbar.classList.toggle('mobile-open');
    });

    // Navigation
    navItems.forEach(function(item) {
      item.addEventListener('click', function() {
        const view = this.getAttribute('data-view');
        switchView(view);
      });
    });

    // Action cards
    document.querySelectorAll('[data-action]').forEach(function(card) {
      card.addEventListener('click', function() {
        const action = this.getAttribute('data-action');
        switchView(action);
      });
    });

    function switchView(view) {
      navItems.forEach(function(item) {
        item.classList.remove('active');
        if (item.getAttribute('data-view') === view) {
          item.classList.add('active');
        }
      });

      viewContents.forEach(function(content) {
        content.classList.add('hidden');
      });

      navbar.classList.remove('mobile-open');

      if (view === 'home') {
        document.getElementById('homeView').classList.remove('hidden');
      } else if (view === 'evaluate') {
        document.getElementById('evaluateView').classList.remove('hidden');
        loadEvaluateOptions();
      } else if (view === 'registration') {
        document.getElementById('registrationView').classList.remove('hidden');
        loadRegistrationView();
      } else if (view === 'results') {
        document.getElementById('resultsView').classList.remove('hidden');
        loadResultsView();
      } else if (view === 'about') {
        document.getElementById('aboutView').classList.remove('hidden');
      }
    }

    window.switchView = switchView;

    // Load evaluation questions
    async function loadQuestions() {
      if (evaluationQuestions) return evaluationQuestions;
      evaluationQuestions = await apiCall('/components_data/evalutation_questions_list', 'GET');
      return evaluationQuestions;
    }

    // Load courses for evaluation - FIXED: Show courses NOT yet evaluated
    async function loadCourses(academicYear, semester) {
      const yearParam = encodeURIComponent(academicYear);
      const result = await apiCall('/courses/evaluation?page=1&limit=100&academic_year=' + yearParam + '&semester=' + semester, 'GET');

      if (result && result.records) {
        return result.records;
      } else if (result && result.data) {
        return result.data;
      } else if (Array.isArray(result)) {
        return result;
      }
      return [];
    }

    // Load Evaluate All view
    async function loadEvaluateAll() {
      const container = document.getElementById('evaluateView');
      container.innerHTML = '<div class="card"><h2 class="card-title">Loading...</h2></div>';

      const years = await apiCall('/components_data/academic_year_option_list', 'GET');

      let html = '<div class="card"><h2 class="card-title">Evaluate All Lecturers</h2>';
      html += '<p class="card-subtitle">Select academic year and semester to view pending evaluations</p>';
      html += '<div class="form-group"><label>Select Academic Year</label><select id="yearSelect" class="form-group input">';

      if (years && years.length > 0) {
        years.forEach(function(year) {
          const selected = year.value === '2025/2026' ? ' selected' : '';
          html += '<option value="' + year.value + '"' + selected + '>' + year.label + '</option>';
        });
      }

      html += '</select></div>';
      html += '<div class="form-group"><label>Select Semester</label><select id="semesterSelect" class="form-group input">';
      html += '<option value="1">Semester 1</option><option value="2">Semester 2</option></select></div>';
      html += '<button class="btn btn-primary" id="loadCoursesBtn">Load Pending Evaluations</button></div>';

      container.innerHTML = html;

      document.getElementById('loadCoursesBtn').addEventListener('click', async function() {
        const year = document.getElementById('yearSelect').value;
        const semester = document.getElementById('semesterSelect').value;

        this.disabled = true;
        this.innerHTML = '<div class="spinner"></div><span>Loading...</span>';

        const courses = await loadCourses(year, semester);
        // FIXED: Filter for courses NOT evaluated (evaluation_status !== '1')
        const unevaluated = courses.filter(function(c) { 
          return c.evaluation_status !== '1' && c.evaluation_status !== 1;
        });

        if (unevaluated.length === 0) {
          container.innerHTML = '<div class="card"><h2 class="card-title">ðŸŽ‰ All Evaluations Complete!</h2><p class="card-subtitle">You have successfully completed all lecturer evaluations for ' + year + ' Semester ' + semester + '.</p><div class="stats-grid"><div class="stat-card"><div class="stat-value">' + courses.length + '</div><div class="stat-label">Total Courses</div></div><div class="stat-card"><div class="stat-value">' + courses.length + '</div><div class="stat-label">Completed</div></div></div><button class="btn btn-primary" onclick="switchView(\'home\')">Back to Home</button></div>';
          return;
        }

        displayCourseList(container, unevaluated, year, semester, true);
      });
    }

    // Load Select Courses view
    async function loadSelectCourses() {
      const container = document.getElementById('selectView');
      container.innerHTML = '<div class="card"><h2 class="card-title">Loading...</h2></div>';

      const years = await apiCall('/components_data/academic_year_option_list', 'GET');

      let html = '<div class="card"><h2 class="card-title">Select Courses to Evaluate</h2>';
      html += '<p class="card-subtitle">Choose specific courses for evaluation</p>';
      html += '<div class="form-group"><label>Select Academic Year</label><select id="yearSelectSel" class="form-group input">';

      if (years && years.length > 0) {
        years.forEach(function(year) {
          const selected = year.value === '2025/2026' ? ' selected' : '';
          html += '<option value="' + year.value + '"' + selected + '>' + year.label + '</option>';
        });
      }

      html += '</select></div>';
      html += '<div class="form-group"><label>Select Semester</label><select id="semesterSelectSel" class="form-group input">';
      html += '<option value="1">Semester 1</option><option value="2">Semester 2</option></select></div>';
      html += '<button class="btn btn-primary" id="loadCoursesSelBtn">Load Available Courses</button></div>';

      container.innerHTML = html;

      document.getElementById('loadCoursesSelBtn').addEventListener('click', async function() {
        const year = document.getElementById('yearSelectSel').value;
        const semester = document.getElementById('semesterSelectSel').value;

        this.disabled = true;
        this.innerHTML = '<div class="spinner"></div><span>Loading...</span>';

        const courses = await loadCourses(year, semester);
        // FIXED: Filter for courses NOT evaluated
        const unevaluated = courses.filter(function(c) { 
          return c.evaluation_status !== '1' && c.evaluation_status !== 1;
        });

        if (unevaluated.length === 0) {
          container.innerHTML = '<div class="card"><h2 class="card-title">ðŸŽ‰ All Evaluations Complete!</h2><p class="card-subtitle">No pending evaluations for ' + year + ' Semester ' + semester + '.</p><button class="btn btn-primary" onclick="switchView(\'home\')">Back to Home</button></div>';
          return;
        }

        displaySelectableCourses(container, unevaluated, year, semester);
      });
    }

    // Display course list (no longer needed - going straight to bypass)
    function displayCourseList(container, courses, year, semester, isAll) {
      // This function is now deprecated - bypass happens directly from the main screen
    }

    // Display selectable courses
    function displaySelectableCourses(container, courses, year, semester) {
      let html = '<div class="card"><h2 class="card-title">Select Courses to Evaluate</h2>';
      html += '<p class="card-subtitle">Choose from ' + courses.length + ' pending evaluation(s)</p>';
      html += '<div class="course-list">';

      courses.forEach(function(course, idx) {
        html += '<div class="course-item" style="cursor: pointer; display: flex; align-items: center;" onclick="document.getElementById(\'course_' + idx + '\').click()">';
        html += '<input type="checkbox" id="course_' + idx + '" style="margin-right: 20px; width: 20px; height: 20px; cursor: pointer;" onclick="event.stopPropagation()">';
        html += '<div style="flex: 1;"><div class="course-code">' + course.code + '</div>';
        html += '<div class="course-title">' + course.title + '</div>';
        html += '<div class="course-lecturer">Lecturer: ' + course.staff_fullname + '</div></div>';
        html += '<span class="badge badge-warning">Not Evaluated</span></div>';
      });

      html += '</div>';
      html += '<div class="btn-group"><button class="btn btn-secondary" onclick="switchView(\'home\')">Cancel</button>';
      html += '<button class="btn btn-success" id="startSelEvalBtn">Evaluate Selected</button></div></div>';

      container.innerHTML = html;

      document.getElementById('startSelEvalBtn').addEventListener('click', function() {
        const selected = [];
        courses.forEach(function(course, idx) {
          if (document.getElementById('course_' + idx).checked) {
            selected.push(course);
          }
        });

        if (selected.length === 0) {
          showAlert('Please select at least one course to evaluate.', 'No Course Selected', 'warning');
          return;
        }

        startEvaluationProcess(container, selected, year, semester);
      });
    }

    // Start evaluation process
    async function startEvaluationProcess(container, courses, year, semester) {
      currentCourses = courses;
      const questions = await loadQuestions();

      if (!questions) {
        container.innerHTML = '<div class="card"><h2 class="card-title">Error</h2><p style="color: var(--danger);">Failed to load evaluation questions</p><button class="btn btn-primary" onclick="switchView(\'home\')">Back</button></div>';
        return;
      }

      displayQuestions(container, questions, courses);
    }

    // Display questions
    function displayQuestions(container, questions, courses) {
      let html = '<div class="card"><h2 class="card-title">Answer Common Questions</h2>';
      html += '<p class="card-subtitle">These answers will apply to all ' + courses.length + ' lecturer(s)</p>';

      const standardOptions = ['Excellent', 'Good', 'Average', 'Fair', 'Poor'];
      const participationOptions = ['100%', '80%', '60%', '40%', '20%'];
      const yesNoOptions = ['Yes', 'No'];

      questions.forEach(function(category, catIdx) {
        if (category.questions_type && category.questions_type.indexOf('COMMENT') !== -1) {
          return;
        }

        html += '<div class="question-section">';
        html += '<div class="question-category">' + category.questions_type + '</div>';

        category.questions.forEach(function(q, qIdx) {
          const isLecturerName = q.question.indexOf('name of the lecturer') !== -1 || q.question.indexOf('Provide the name') !== -1;
          const isComment = q.question.indexOf('Mention at least') !== -1 || q.question.indexOf('What factors') !== -1 || q.question.indexOf('What challenges') !== -1 || q.question.indexOf('obstacles') !== -1 || q.question.indexOf('Given another chance') !== -1 || q.question.indexOf('recommendations') !== -1;

          if (isLecturerName || isComment) {
            return;
          }

          html += '<div class="question-item" data-cat="' + catIdx + '" data-q="' + qIdx + '">';
          html += '<div class="question-text">' + q.question + '</div>';

          let options = standardOptions;
          if (q.question.indexOf('level of participation') !== -1 || q.question.indexOf('level of preparation') !== -1) {
            options = participationOptions;
          } else if (q.question.indexOf('would you want to have another course') !== -1) {
            options = yesNoOptions;
          }

          html += '<div class="options">';
          options.forEach(function(opt, optIdx) {
            html += '<div class="option" data-cat="' + catIdx + '" data-q="' + qIdx + '" data-value="' + opt + '">' + opt + '</div>';
          });
          html += '</div></div>';
        });

        html += '</div>';
      });

      html += '<div class="btn-group"><button class="btn btn-secondary" onclick="switchView(\'home\')">Cancel</button>';
      html += '<button class="btn btn-primary" id="continueToLecturersBtn">Continue to Lecturer Names</button></div></div>';

      container.innerHTML = html;

      commonAnswers = [];
      questions.forEach(function(cat) {
        const catAnswers = {
          questions_type: cat.questions_type,
          questions: []
        };

        cat.questions.forEach(function(q) {
          catAnswers.questions.push({
            question_id: q.question_id,
            question: q.question,
            answer: ''
          });
        });

        commonAnswers.push(catAnswers);
      });

      document.querySelectorAll('.option').forEach(function(opt) {
        opt.addEventListener('click', function() {
          const catIdx = parseInt(this.getAttribute('data-cat'));
          const qIdx = parseInt(this.getAttribute('data-q'));
          const value = this.getAttribute('data-value');

          document.querySelectorAll('.option[data-cat="' + catIdx + '"][data-q="' + qIdx + '"]').forEach(function(o) {
            o.classList.remove('selected');
          });
          this.classList.add('selected');

          commonAnswers[catIdx].questions[qIdx].answer = value;
        });
      });

      document.getElementById('continueToLecturersBtn').addEventListener('click', function() {
        collectLecturerNames(container, courses);
      });
    }

    // Collect lecturer names
    function collectLecturerNames(container, courses) {
      let html = '<div class="card"><h2 class="card-title">Confirm Lecturer Names</h2>';
      html += '<p class="card-subtitle">Verify or modify lecturer names before submission</p>';

      courses.forEach(function(course, idx) {
        html += '<div class="form-group">';
        html += '<label><strong>' + course.code + '</strong> - ' + course.title + '</label>';
        html += '<input type="text" class="form-group input" id="lecturer_' + idx + '" placeholder="Lecturer name" data-suggested="' + course.staff_fullname + '" value="' + course.staff_fullname + '">';
        html += '</div>';
      });

      html += '<div class="btn-group"><button class="btn btn-secondary" onclick="switchView(\'home\')">Cancel</button>';
      html += '<button class="btn btn-success" id="submitEvalBtn">Submit All Evaluations</button></div></div>';

      container.innerHTML = html;

      document.getElementById('submitEvalBtn').addEventListener('click', function() {
        submitEvaluations(container, courses);
      });
    }

    // Submit evaluations
    async function submitEvaluations(container, courses) {
      container.innerHTML = '<div class="card"><h2 class="card-title">Submitting Evaluations...</h2><p class="card-subtitle">Please wait while we process your submissions</p><div class="progress-bar"><div class="progress-fill" id="progressBar" style="width: 0%"></div></div><div id="progressText" style="text-align: center; margin-top: 24px; font-size: 18px; font-weight: 700; color: var(--primary);">0 / ' + courses.length + '</div></div>';

      let success = 0;
      let failed = 0;

      for (let i = 0; i < courses.length; i++) {
        const course = courses[i];
        const lecturerInput = document.getElementById('lecturer_' + i);
        const lecturerName = lecturerInput ? (lecturerInput.value || lecturerInput.getAttribute('data-suggested')) : course.staff_fullname;

        const answers = JSON.parse(JSON.stringify(commonAnswers));

        answers.forEach(function(cat) {
          cat.questions.forEach(function(q) {
            if (q.question.indexOf('name of the lecturer') !== -1 || q.question.indexOf('Provide the name') !== -1) {
              q.answer = lecturerName;
            }
          });
        });

        const evalData = {
          answers: answers,
          class_id: course.class_id
        };

        const result = await apiCall('/courses/evaluationadd', 'POST', evalData);

        if (result) {
          success++;
        } else {
          failed++;
        }

        const progress = ((i + 1) / courses.length) * 100;
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        if (progressBar) progressBar.style.width = progress + '%';
        if (progressText) progressText.textContent = (i + 1) + ' / ' + courses.length;
      }

      displayResults(container, success, failed);
    }

    // Display results
    function displayResults(container, success, failed) {
      let html = '<div class="card"><h2 class="card-title">âœ… Evaluation Complete!</h2>';
      html += '<p class="card-subtitle">Your evaluations have been processed</p>';
      html += '<div class="stats-grid">';
      html += '<div class="stat-card"><div class="stat-value">' + success + '</div><div class="stat-label">Successful</div></div>';
      html += '<div class="stat-card"><div class="stat-value">' + failed + '</div><div class="stat-label">Failed</div></div>';
      html += '</div>';
      
      if (success > 0) {
        html += '<p style="margin: 24px 0; color: var(--success); font-weight: 600; font-size: 16px;">ðŸŽ‰ ' + success + ' lecturer evaluation(s) submitted successfully!</p>';
      }
      
      html += '<p style="margin-bottom: 24px; color: var(--gray);">You can verify your submissions on the GCTU SIP portal.</p>';
      html += '<div class="link-box">';
      html += '<a href="https://gctusip.gctu.edu.gh" target="_blank" class="btn-link">';
      html += '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>';
      html += '<span>Visit GCTU SIP Portal</span></a></div>';
      html += '<button class="btn btn-primary" onclick="switchView(\'home\')" style="margin-top: 24px;">Back to Home</button></div>';

      container.innerHTML = html;
    }

    // Load Results View
    async function loadResultsView() {
      const container = document.getElementById('resultsView');
      container.innerHTML = '<div class="card"><h2 class="card-title">Loading Results...</h2><div style="text-align: center; padding: 40px;"><div class="spinner"></div></div></div>';
      
      if (!authToken) {
        container.innerHTML = '<div class="card"><h2 class="card-title">Authentication Required</h2><p style="color: var(--danger); margin: 20px 0;">Please login first to view your results.</p><button class="btn btn-primary" onclick="logoutBtn.click()">Go to Login</button></div>';
        return;
      }
      
      try {
        console.log('Fetching results with token:', authToken.substring(0, 20) + '...');
        
        // Try both endpoints - regular and print
        let result = await apiCall('/courses/results?page=1&limit=100', 'GET');
        console.log('Results response:', result);
        
        // If we got HTML response (print view)
        if (result && result.isHtml) {
          console.log('Got HTML response, parsing...');
          displayHtmlResults(container, result.html);
          return;
        }
        
        // Check if we got an error (like 401)
        if (result && result.error) {
          console.log('API returned error:', result.error);
          if (result.error.toLowerCase().includes('unauthorized') || result.error.toLowerCase().includes('401')) {
            authToken = null;
            localStorage.removeItem('authToken');
            container.innerHTML = '<div class="card"><h2 class="card-title">Session Expired</h2><p style="color: var(--danger); margin: 20px 0;">Your session has expired. Please login again.</p><button class="btn btn-primary" onclick="logoutBtn.click()">Go to Login</button></div>';
            return;
          }
        }
        
        // If no records, try print endpoint
        if (!result || !result.records || result.records.length === 0) {
          console.log('No JSON records, trying print endpoint...');
          const printResult = await apiCall('/courses/results?page=1&limit=100&export=print', 'GET');
          console.log('Print response:', printResult);
          
          if (printResult && printResult.isHtml) {
            displayHtmlResults(container, printResult.html);
            return;
          }
          
          container.innerHTML = '<div class="card"><h2 class="card-title">No Results Available</h2><p style="color: var(--gray); margin: 20px 0;">You don\'t have any results yet, or results are not available for the current semester.</p><div style="margin-top: 20px;"><button class="btn btn-primary" onclick="loadResultsView()">Retry</button><button class="btn btn-secondary" onclick="switchView(\'home\')">Back to Home</button></div></div>';
          return;
        }
        
        displayResultsTable(container, result);
      } catch (error) {
        console.error('Load results error:', error);
        container.innerHTML = '<div class="card"><h2 class="card-title">Error Loading Results</h2><p style="color: var(--danger);">Failed to load results: ' + error.message + '</p><p style="color: var(--gray); margin-top: 10px;">This could be due to:<br>â€¢ Your session has expired - please login again<br>â€¢ Network connection issues<br>â€¢ The results service is temporarily unavailable</p><div style="margin-top: 20px;"><button class="btn btn-primary" onclick="loadResultsView()">Retry</button><button class="btn btn-secondary" onclick="logoutBtn.click()">Login Again</button></div></div>';
      }
    }

    // Display HTML results (when API returns HTML)
    function displayHtmlResults(container, htmlContent) {
      // Parse the HTML to extract table data
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlContent, 'text/html');
      
      // Try to find the results table
      const table = doc.querySelector('table');
      
      if (!table) {
        // If no table, just display the HTML content styled
        let html = '<div class="card">';
        html += '<div class="result-header" style="text-align: center; margin-bottom: 30px;">';
        html += '<h2 class="card-title">Course Results</h2>';
        html += '<p style="color: var(--gray);">Academic Performance Overview</p>';
        html += '</div>';
        html += '<div style="margin-bottom: 30px; display: flex; gap: 12px; flex-wrap: wrap;" class="no-print">';
        html += '<button class="btn btn-success" onclick="downloadResultsPDF()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>Download PDF</button>';
        html += '<button class="btn btn-primary" onclick="window.print()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>Print</button>';
        html += '<button class="btn btn-secondary" onclick="switchView(\'home\')">Back to Home</button>';
        html += '</div>';
        html += '<div id="printableResults" style="overflow-x: auto;">' + htmlContent + '</div>';
        html += '<style>#printableResults table { font-size: 18px !important; } #printableResults th { font-size: 19px !important; padding: 12px !important; } #printableResults td { font-size: 18px !important; padding: 12px !important; } #printableResults h1 { font-size: 28px !important; } #printableResults h2 { font-size: 26px !important; } #printableResults h3 { font-size: 24px !important; } #printableResults h4, #printableResults h5, #printableResults h6 { font-size: 20px !important; } #printableResults p, #printableResults small { font-size: 16px !important; }</style>';
        html += '</div>';
        container.innerHTML = html;
        return;
      }
      
      // Extract data from table
      const rows = table.querySelectorAll('tbody tr');
      const records = [];
      
      rows.forEach(function(row) {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 5) {
          records.push({
            course_code: cells[0].textContent.trim(),
            course_title: cells[1].textContent.trim(),
            lecturer_name: cells[2].textContent.trim(),
            grade: cells[3].textContent.trim(),
            credit_hours: cells[4].textContent.trim(),
            semester: cells[5] ? cells[5].textContent.trim() : 'N/A'
          });
        }
      });
      
      if (records.length > 0) {
        displayResultsTable(container, { records: records, pagination: { totalRecords: records.length } });
      } else {
        // Display the raw HTML with balanced styling
        let html = '<div style="max-width: 1100px; margin: 0 auto;">';
        html += '<div class="card">';
        html += '<div class="result-header" style="text-align: center; margin-bottom: 30px;">';
        html += '<h2 class="card-title">Course Results</h2>';
        html += '</div>';
        html += '<div style="margin-bottom: 30px; display: flex; gap: 12px; flex-wrap: wrap;" class="no-print">';
        html += '<button class="btn btn-success" onclick="downloadResultsPDF()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>Download PDF</button>';
        html += '<button class="btn btn-primary" onclick="window.print()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>Print</button>';
        html += '<button class="btn btn-secondary" onclick="switchView(\'home\')">Back to Home</button>';
        html += '</div>';
        html += '<div id="printableResults" style="overflow-x: auto; width: 100%;">' + htmlContent + '</div>';
        html += '<style>';
        html += '#printableResults { width: 100%; overflow-x: auto; }';
        html += '#printableResults table { width: 100% !important; font-size: 14px !important; border-collapse: collapse !important; table-layout: auto !important; }';
        html += '#printableResults th { font-size: 15px !important; font-weight: 700 !important; padding: 12px 8px !important; background: #f8f9fa !important; white-space: nowrap !important; }';
        html += '#printableResults td { font-size: 14px !important; padding: 10px 8px !important; border-bottom: 1px solid #e0e0e0 !important; }';
        html += '#printableResults h1 { font-size: 24px !important; margin: 12px 0 !important; font-weight: 700 !important; }';
        html += '#printableResults h2 { font-size: 20px !important; margin: 10px 0 !important; font-weight: 700 !important; }';
        html += '#printableResults h3 { font-size: 18px !important; margin: 10px 0 !important; font-weight: 700 !important; }';
        html += '#printableResults h4 { font-size: 16px !important; margin: 8px 0 !important; font-weight: 600 !important; }';
        html += '#printableResults h5, #printableResults h6 { font-size: 15px !important; margin: 6px 0 !important; font-weight: 600 !important; }';
        html += '#printableResults p { font-size: 14px !important; margin: 6px 0 !important; }';
        html += '#printableResults strong, #printableResults b { font-weight: 700 !important; }';
        html += '#printableResults small { font-size: 13px !important; }';
        html += '</style>';
        html += '</div></div>';
        container.innerHTML = html;
      }
    }

    // Display results table
    function displayResultsTable(container, data) {
      const records = data.records || [];
      const totalCredits = records.reduce(function(sum, r) { return sum + (parseFloat(r.credit_hours) || 0); }, 0);
      
      let html = '<div style="max-width: 900px; margin: 0 auto;">';
      html += '<div class="card" id="printableResults" style="border-radius: 16px; padding: 30px;">';
      html += '<div class="result-header" style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--border);">';
      html += '<h2 class="card-title" style="margin-bottom: 10px; font-size: 36px;">Course Results</h2>';
      html += '<p style="color: var(--gray); font-size: 20px; font-weight: 500;">Academic Performance Overview</p>';
      html += '</div>';
      
      html += '<div class="stats-grid" style="margin-bottom: 40px;">';
      html += '<div class="stat-card"><div class="stat-value">' + records.length + '</div><div class="stat-label">Total Courses</div></div>';
      html += '<div class="stat-card"><div class="stat-value">' + totalCredits.toFixed(1) + '</div><div class="stat-label">Total Credits</div></div>';
      html += '<div class="stat-card"><div class="stat-value">' + (data.pagination ? data.pagination.totalRecords : records.length) + '</div><div class="stat-label">All Records</div></div>';
      html += '</div>';
      
      html += '<div style="margin-bottom: 30px; display: flex; gap: 12px; flex-wrap: wrap;" class="no-print">';
      html += '<button class="btn btn-success" onclick="downloadResultsPDF()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>Download PDF</button>';
      html += '<button class="btn btn-primary" onclick="window.print()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>Print</button>';
      html += '<button class="btn btn-secondary" onclick="switchView(\'home\')">Back to Home</button>';
      html += '</div>';
      
      html += '<table class="results-table" style="width: 100%; border-collapse: collapse; margin-top: 30px;">';
      html += '<thead style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white;">';
      html += '<tr><th style="padding: 22px; text-align: left; font-weight: 700; font-size: 17px; text-transform: uppercase; letter-spacing: 0.5px;">Course</th>';
      html += '<th style="padding: 22px; text-align: left; font-weight: 700; font-size: 17px; text-transform: uppercase; letter-spacing: 0.5px;">Lecturer</th>';
      html += '<th style="padding: 22px; text-align: left; font-weight: 700; font-size: 17px; text-transform: uppercase; letter-spacing: 0.5px;">Grade</th>';
      html += '<th style="padding: 22px; text-align: left; font-weight: 700; font-size: 17px; text-transform: uppercase; letter-spacing: 0.5px;">Credits</th>';
      html += '<th style="padding: 22px; text-align: left; font-weight: 700; font-size: 17px; text-transform: uppercase; letter-spacing: 0.5px;">Semester</th></tr>';
      html += '</thead><tbody>';
      
      records.forEach(function(record) {
        const grade = record.grade || 'N/A';
        let gradeClass = '';
        if (grade.toUpperCase().startsWith('A')) gradeClass = 'background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: var(--success);';
        else if (grade.toUpperCase().startsWith('B')) gradeClass = 'background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #2563eb;';
        else if (grade.toUpperCase().startsWith('C')) gradeClass = 'background: linear-gradient(135deg, #fef3c7, #fde68a); color: #d97706;';
        else if (grade.toUpperCase().startsWith('D')) gradeClass = 'background: linear-gradient(135deg, #fed7aa, #fdba74); color: #ea580c;';
        else if (grade.toUpperCase().startsWith('F')) gradeClass = 'background: linear-gradient(135deg, #fee, #fcc); color: var(--danger);';
        
        html += '<tr style="border-bottom: 1px solid var(--border);">';
        html += '<td style="padding: 22px;"><div style="font-weight: 800; color: var(--primary); font-size: 21px;">' + (record.course_code || 'N/A') + '</div>';
        html += '<div style="color: var(--dark); font-weight: 600; margin: 6px 0; font-size: 17px; line-height: 1.4;">' + (record.course_title || 'N/A') + '</div></td>';
        html += '<td style="padding: 22px; color: var(--gray); font-size: 17px; line-height: 1.5;">' + (record.lecturer_name || record.staff_fullname || 'N/A') + '</td>';
        html += '<td style="padding: 22px;"><span style="display: inline-block; padding: 14px 22px; border-radius: 10px; font-weight: 700; font-size: 21px; ' + gradeClass + '">' + grade + '</span></td>';
        html += '<td style="padding: 22px; font-weight: 700; text-align: center; font-size: 20px;">' + (record.credit_hours || 'N/A') + '</td>';
        html += '<td style="padding: 22px; font-size: 17px;">' + (record.semester ? 'Semester ' + record.semester : 'N/A') + '</td>';
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      
      html += '<div style="text-align: center; margin-top: 35px; padding-top: 25px; border-top: 2px solid var(--border); color: var(--gray); font-size: 17px;" class="print-footer">';
      html += '<p style="font-size: 20px; margin-bottom: 8px;"><strong>Ghana Communication Technology University</strong></p>';
      html += '<p>Academic Records</p>';
      html += '</div></div></div>';
      
      container.innerHTML = html;
    }

    // ====================
    // COURSE REGISTRATION
    // ====================
    
    // Load Registration View
    async function loadRegistrationView() {
      const container = document.getElementById('registrationView');
      container.innerHTML = '<div class="card"><h2 class="card-title">Loading courses...</h2></div>';
      
      const data = await apiCall('/courses/index/', 'GET');
      
      console.log('Registration data received:', data);
      
      if (!data) {
        return; // Token expired, handled by apiCall
      }
      
      // Handle both JSON and HTML responses
      if (data.html && data.isHtml) {
        // HTML response - parse it
        displayCoursesFromHTML(container, data.html);
      } else if (data && data.semesterCourseList) {
        // Handle the actual API response structure
        displayCoursesListWithRegistration(container, data);
      } else if (data && Array.isArray(data)) {
        displayCoursesList(container, data);
      } else if (data && data.courses) {
        displayCoursesList(container, data.courses);
      } else {
        container.innerHTML = '<div class="card"><h2 class="card-title">No Courses Found</h2><p>No courses available for registration.</p></div>';
      }
    }
    
    // Display courses from HTML
    function displayCoursesFromHTML(container, htmlContent) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlContent, 'text/html');
      
      // Try multiple table selectors
      let rows = doc.querySelectorAll('table tbody tr');
      if (rows.length === 0) {
        rows = doc.querySelectorAll('table tr');
      }
      
      console.log('Found', rows.length, 'rows in HTML');
      
      const courses = [];
      rows.forEach(function(row, index) {
        const cells = row.querySelectorAll('td');
        
        // Skip header rows
        if (cells.length === 0) {
          const headers = row.querySelectorAll('th');
          if (headers.length > 0) {
            console.log('Skipping header row', index);
            return;
          }
        }
        
        if (cells.length >= 3) {
          const actionCell = cells[cells.length - 1];
          const links = actionCell.querySelectorAll('a');
          let classId = '';
          let status = 'Not Registered';
          
          console.log('Row', index, 'cells:', cells.length, 'action cell:', actionCell.innerHTML);
          
          // Check for register link
          links.forEach(function(link) {
            const href = link.getAttribute('href') || '';
            const text = link.textContent.trim().toLowerCase();
            
            console.log('Link:', text, 'href:', href);
            
            if (text.includes('register') && !text.includes('registered')) {
              const match = href.match(/\/courses\/enroll\/([^/?]+)/);
              if (match) {
                classId = match[1];
                status = 'Not Registered';
                console.log('Found register link, classId:', classId);
              }
            } else if (text.includes('registered') || text === 'view' || href.includes('registered')) {
              status = 'Registered';
              console.log('Course is registered');
            }
          });
          
          // If no links but cell contains "Registered" text
          if (!classId && actionCell.textContent.trim().toLowerCase().includes('registered')) {
            status = 'Registered';
          }
          
          const course = {
            code: cells[0].textContent.trim(),
            title: cells[1].textContent.trim(),
            credit_hours: cells[2] ? cells[2].textContent.trim() : '',
            status: status,
            class_id: classId || ''
          };
          
          console.log('Parsed course:', course);
          courses.push(course);
        }
      });
      
      console.log('Total courses parsed:', courses.length);
      
      if (courses.length > 0) {
        displayCoursesList(container, courses);
      } else {
        container.innerHTML = '<div class="card"><h2 class="card-title">No Courses Found</h2><p>No courses available for registration.</p></div>';
      }
    }
    
    // Display courses from registration data structure
    function displayCoursesListWithRegistration(container, data) {
      const allCourses = [];
      
      console.log('Processing registration data:', data);
      
      // Process semester courses
      if (data.semesterCourseList && Array.isArray(data.semesterCourseList)) {
        data.semesterCourseList.forEach(function(course) {
          console.log('Semester course:', course);
          // The course structure has: {class_id, course_id, course: {code, course_name, ...}}
          const courseObj = course.course || course;
          
          // Get title from nested course object
          const courseTitle = courseObj.course_name || courseObj.name || courseObj.course_title || courseObj.title || 
                             courseObj.courseName || courseObj.courseTitle || 
                             course.course_name || course.name || course.course_title || course.title || 'N/A';
          const courseCode = courseObj.code || courseObj.course_code || courseObj.courseCode || 
                            course.code || course.course_code || course.courseCode || '';
          const creditHours = courseObj.credit_hours || courseObj.credits || courseObj.creditHours || 
                             course.credit_hours || course.credits || course.creditHours || '';
          
          console.log('Extracted - Code:', courseCode, 'Title:', courseTitle, 'Credits:', creditHours);
          
          allCourses.push({
            code: courseCode,
            title: courseTitle,
            credit_hours: creditHours,
            class_id: course.class_id || course.classId || courseObj.class_id || courseObj.classId || '',
            status: 'Not Registered'
          });
        });
      }
      
      // Mark enrolled courses as registered
      if (data.enrolledCoueseList && Array.isArray(data.enrolledCoueseList)) {
        data.enrolledCoueseList.forEach(function(enrolled) {
          console.log('Enrolled course:', enrolled);
          const courseObj = enrolled.course || enrolled;
          const courseTitle = courseObj.course_name || courseObj.course_title || courseObj.title || 
                             courseObj.name || courseObj.courseName || courseObj.courseTitle || 
                             enrolled.course_name || enrolled.course_title || enrolled.title || enrolled.name || 'N/A';
          const courseCode = courseObj.code || courseObj.course_code || courseObj.courseCode || 
                            enrolled.code || enrolled.course_code || enrolled.courseCode || '';
          
          const course = allCourses.find(c => c.class_id === (enrolled.class_id || enrolled.classId));
          if (course) {
            course.status = 'Registered';
            // Update title if not set properly
            if (course.title === 'N/A' && courseTitle !== 'N/A') {
              course.title = courseTitle;
            }
            if (course.code === '' && courseCode !== '') {
              course.code = courseCode;
            }
          } else {
            // Add enrolled course if not in semester list
            allCourses.push({
              code: courseCode,
              title: courseTitle,
              credit_hours: courseObj.credit_hours || courseObj.credits || courseObj.creditHours || 
                           enrolled.credit_hours || enrolled.credits || enrolled.creditHours || '',
              class_id: enrolled.class_id || enrolled.classId || '',
              status: 'Registered'
            });
          }
        });
      }
      
      console.log('Processed courses:', allCourses);
      
      if (allCourses.length > 0) {
        displayCoursesList(container, allCourses);
      } else {
        container.innerHTML = '<div class="card"><h2 class="card-title">No Courses Found</h2><p>No courses available for registration.</p></div>';
      }
    }
    
    // Display courses list
    function displayCoursesList(container, courses) {
      const registered = courses.filter(c => c.status === 'Registered' || c.status === '1' || c.status === 1);
      const notRegistered = courses.filter(c => c.status !== 'Registered' && c.status !== '1' && c.status !== 1);
      
      let html = '<div class="card">';
      html += '<h2 class="card-title">Course Registration</h2>';
      html += '<p class="card-subtitle">Manage your course registrations</p>';
      
      html += '<div class="stats-grid" style="margin: 30px 0;">';
      html += '<div class="stat-card"><div class="stat-value">' + courses.length + '</div><div class="stat-label">Total Courses</div></div>';
      html += '<div class="stat-card"><div class="stat-value" style="color: var(--success);">' + registered.length + '</div><div class="stat-label">Registered</div></div>';
      html += '<div class="stat-card"><div class="stat-value" style="color: var(--danger);">' + notRegistered.length + '</div><div class="stat-label">Not Registered</div></div>';
      html += '</div>';
      
      if (notRegistered.length > 0) {
        html += '<div style="margin-bottom: 24px; display: flex; gap: 12px; flex-wrap: wrap;">';
        html += '<button class="btn btn-primary" id="registerAllBtn"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>Register All Courses</button>';
        html += '<button class="btn btn-success" id="viewRegistrationBtn"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>Print/Download</button>';
        html += '</div>';
      } else {
        html += '<div style="margin-bottom: 24px;">';
        html += '<button class="btn btn-success" id="viewRegistrationBtn"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>Print/Download</button>';
        html += '</div>';
      }
      
      html += '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
      html += '<thead style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white;">';
      html += '<tr><th style="padding: 18px; text-align: left; font-weight: 700; font-size: 15px; text-transform: uppercase;">Course Code</th>';
      html += '<th style="padding: 18px; text-align: left; font-weight: 700; font-size: 15px; text-transform: uppercase;">Course Title</th>';
      html += '<th style="padding: 18px; text-align: left; font-weight: 700; font-size: 15px; text-transform: uppercase;">Credits</th>';
      html += '<th style="padding: 18px; text-align: center; font-weight: 700; font-size: 15px; text-transform: uppercase;">Status</th>';
      html += '<th style="padding: 18px; text-align: center; font-weight: 700; font-size: 15px; text-transform: uppercase;">Action</th></tr>';
      html += '</thead><tbody>';
      
      courses.forEach(function(course, index) {
        const isRegistered = course.status === 'Registered' || course.status === '1' || course.status === 1;
        const statusBadge = isRegistered
          ? '<span style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: var(--success); padding: 6px 16px; border-radius: 20px; font-weight: 600; font-size: 13px;">Registered</span>'
          : '<span style="background: linear-gradient(135deg, #fee, #fcc); color: var(--danger); padding: 6px 16px; border-radius: 20px; font-weight: 600; font-size: 13px;">Not Registered</span>';
        
        const actionBtn = isRegistered
          ? '<span style="color: var(--gray); font-size: 13px;">-</span>'
          : '<button class="btn btn-sm btn-primary" onclick="registerSingleCourse(\'' + course.class_id + '\', ' + index + ')">Register</button>';
        
        html += '<tr style="border-bottom: 1px solid var(--border);">';
        html += '<td style="padding: 16px; font-weight: 600; color: var(--primary);">' + (course.code || 'N/A') + '</td>';
        html += '<td style="padding: 16px;">' + (course.title || course.name || 'N/A') + '</td>';
        html += '<td style="padding: 16px;">' + (course.credit_hours || course.credits || 'N/A') + '</td>';
        html += '<td style="padding: 16px; text-align: center;">' + statusBadge + '</td>';
        html += '<td style="padding: 16px; text-align: center;">' + actionBtn + '</td>';
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      
      container.innerHTML = html;
      
      // Attach event listeners
      if (notRegistered.length > 0) {
        document.getElementById('registerAllBtn').addEventListener('click', function() {
          registerAllCourses(container, notRegistered);
        });
      }
      
      const viewBtn = document.getElementById('viewRegistrationBtn');
      if (viewBtn) {
        viewBtn.addEventListener('click', function() {
          loadRegistrationPrintView(container);
        });
      }
    }
    
    // Register single course
    async function registerSingleCourse(classId, index) {
      // Show loading
      const loadingPromise = showAlert('Registering course, please wait...', 'Processing', 'info');
      
      const result = await apiCall('/courses/enroll/' + classId + '?label=Register', 'GET');
      
      // Close all loading dialogs immediately
      const overlays = document.querySelectorAll('.custom-dialog-overlay');
      overlays.forEach(function(overlay) {
        if (overlay && overlay.parentNode) {
          document.body.removeChild(overlay);
        }
      });
      
      if (result && result.error === 'not_eligible') {
        // User hasn't paid - show eligibility dialog immediately
        // Use requestAnimationFrame to ensure DOM is clean before showing new dialog
        requestAnimationFrame(function() {
          showCustomDialog({
            title: 'Enrollment Requirements Not Met',
            message: 'You currently do not meet the eligibility criteria for course enrollment in the current semester. To proceed with course enrollment, kindly ensure that you have made a payment of at least 50% of your school fees to fulfill the enrollment requirements.',
            type: 'warning',
            buttons: [{ text: 'I Understand', action: 'ok', primary: true }]
          });
        });
      } else if (result) {
        await showAlert('Course registered successfully!', 'Success', 'success');
        loadRegistrationView(); // Reload
      } else {
        await showAlert('Failed to register course. Please try again later.', 'Registration Failed', 'error');
      }
    }
    
    // Register all courses
    async function registerAllCourses(container, courses) {
      container.innerHTML = '<div class="card"><h2 class="card-title">Registering Courses...</h2><p class="card-subtitle">Please wait while we register your courses</p><div style="margin: 40px 0; text-align: center;"><div style="width: 100px; height: 100px; border: 6px solid #e0e0e0; border-top: 6px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 30px;"></div><p style="font-size: 18px; font-weight: 600; color: var(--dark); margin-bottom: 10px;">Processing ' + courses.length + ' courses...</p></div></div><style>@keyframes spin { to { transform: rotate(360deg); }}</style>';
      
      let success = 0;
      let failed = 0;
      let notEligible = false;
      
      for (let i = 0; i < courses.length; i++) {
        const course = courses[i];
        
        try {
          const result = await apiCall('/courses/enroll/' + course.class_id + '?label=Register', 'GET');
          
          if (result && result.error === 'not_eligible') {
            notEligible = true;
            failed++;
          } else if (result) {
            success++;
          } else {
            failed++;
          }
        } catch (error) {
          failed++;
        }
        
        await new Promise(resolve => setTimeout(resolve, 300));
      }
      
      // Show results
      if (notEligible) {
        // Clear the container first
        container.innerHTML = '';
        
        // Show custom dialog for eligibility issue immediately
        setTimeout(function() {
          showCustomDialog({
            title: 'Enrollment Requirements Not Met',
            message: 'You currently do not meet the eligibility criteria for course enrollment in the current semester. To proceed with course enrollment, kindly ensure that you have made a payment of at least 50% of your school fees to fulfill the enrollment requirements.',
            type: 'warning',
            buttons: [{ text: 'I Understand', action: 'ok', primary: true }]
          });
        }, 0);
        loadRegistrationView(); // Reload to show current state
        return;
      }
      
      let html = '<div class="card">';
      html += '<div style="text-align: center; margin-bottom: 30px;">';
      
      if (success > 0) {
        html += '<svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color: var(--success); margin-bottom: 20px;">';
        html += '<circle cx="12" cy="12" r="10" stroke-width="2"></circle>';
        html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4" />';
        html += '</svg>';
        html += '<h2 class="card-title" style="color: var(--success); margin-bottom: 16px;">Registration Successful!</h2>';
        html += '<p style="color: var(--gray); font-size: 16px; margin-bottom: 30px;">Your courses have been registered successfully.</p>';
      } else {
        html += '<svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color: var(--danger); margin-bottom: 20px;">';
        html += '<circle cx="12" cy="12" r="10" stroke-width="2"></circle>';
        html += '<line x1="15" y1="9" x2="9" y2="15" stroke-width="2"></line>';
        html += '<line x1="9" y1="9" x2="15" y2="15" stroke-width="2"></line>';
        html += '</svg>';
        html += '<h2 class="card-title" style="color: var(--danger); margin-bottom: 16px;">Registration Failed</h2>';
        html += '<p style="color: var(--gray); font-size: 16px; margin-bottom: 30px;">Unable to register courses.</p>';
      }
      
      html += '</div>';
      
      html += '<div class="stats-grid">';
      html += '<div class="stat-card"><div class="stat-value">' + courses.length + '</div><div class="stat-label">Total</div></div>';
      html += '<div class="stat-card"><div class="stat-value" style="color: var(--success);">' + success + '</div><div class="stat-label">Registered</div></div>';
      if (failed > 0) {
        html += '<div class="stat-card"><div class="stat-value" style="color: var(--danger);">' + failed + '</div><div class="stat-label">Failed</div></div>';
      }
      html += '</div>';
      
      html += '<div style="margin-top: 30px; display: flex; gap: 12px; justify-content: center;">';
      html += '<button class="btn btn-primary" onclick="loadRegistrationView()">View Registration</button>';
      html += '<button class="btn btn-secondary" onclick="switchView(\'home\')">Back to Home</button>';
      html += '</div></div>';
      
      container.innerHTML = html;
    }
    
    // Load print view for registration
    async function loadRegistrationPrintView(container) {
      container.innerHTML = '<div class="card"><h2 class="card-title">Loading preview...</h2></div>';

      const htmlData = await apiCall('/courses/index/?export=print', 'GET');

      if (!htmlData) {
        return;
      }

      if (htmlData.html) {
        // Store the original HTML for PDF generation
        window.registrationOriginalHTML = htmlData.html;
        
        // HTML response - display with minimal wrapper
        let html = '<div class="card">';
        html += '<div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;" class="no-print">';
        html += '<button class="btn btn-success" onclick="downloadRegistrationPDF()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>Download PDF</button>';
        html += '<button class="btn btn-primary" onclick="printRegistration()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>Print</button>';
        html += '<button class="btn btn-secondary" onclick="loadRegistrationView()">Back</button>';
        html += '</div>';
        
        // Add print styles
        html += '<style>';
        html += '@media print { ';
        html += '  .no-print, .btn { display: none !important; }';
        html += '  body { margin: 0; padding: 0; background: white; }';
        html += '  .card { border: none !important; box-shadow: none !important; padding: 0 !important; margin: 0 !important; background: white !important; }';
        html += '  @page { margin: 10mm; size: A4; }';
        html += '}';
        html += '</style>';
        
        // Add the original HTML content directly
        html += '<div id="printableRegistration">' + htmlData.html + '</div>';
        html += '</div>';

        container.innerHTML = html;
      } else {
        container.innerHTML = '<div class="card"><h2 class="card-title">Preview Not Available</h2><p>Unable to load registration preview.</p><button class="btn btn-secondary" onclick="loadRegistrationView()">Back</button></div>';
      }
    }
    
    // Print registration function
    window.printRegistration = function() {
      window.print();
    };
    
    // Download registration as PDF
    window.downloadRegistrationPDF = async function() {
      const element = document.getElementById('printableRegistration');

      if (!element || !window.registrationOriginalHTML) {
        showAlert('No content available to download. Please try again.', 'Download Failed', 'error');
        return;
      }

      // Show loading indicator
      const loadingOverlay = document.createElement('div');
      loadingOverlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;';
      loadingOverlay.innerHTML = '<div style="background: white; padding: 40px 50px; border-radius: 16px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);"><div style="width: 60px; height: 60px; border: 4px solid #e0e0e0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div><p style="color: var(--dark); font-weight: 700; font-size: 18px; margin-bottom: 8px;">Generating PDF...</p><p style="color: var(--gray); font-size: 14px;">Please wait a moment</p></div><style>@keyframes spin { to { transform: rotate(360deg); }}</style>';
      document.body.appendChild(loadingOverlay);

      try {
        // Create a wrapper with the original HTML
        const wrapper = document.createElement('div');
        wrapper.style.cssText = 'position: fixed; left: -9999px; top: 0; width: 1200px; padding: 40px; box-sizing: border-box; background: white;';
        wrapper.innerHTML = window.registrationOriginalHTML;
        document.body.appendChild(wrapper);

        // Wait for rendering
        await new Promise(resolve => setTimeout(resolve, 200));

        // Capture with html2canvas
        const canvas = await html2canvas(wrapper, {
          scale: 2.5,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff',
          windowWidth: 1200,
          windowHeight: wrapper.scrollHeight,
          onclone: function(clonedDoc) {
            const cloned = clonedDoc.body.querySelector('div');
            if (cloned) {
              cloned.style.left = '0';
              cloned.style.position = 'relative';
              
              // Increase font sizes for better PDF readability
              const allElements = cloned.querySelectorAll('*');
              allElements.forEach(function(el) {
                const computedStyle = window.getComputedStyle(el);
                if (computedStyle.fontSize) {
                  const currentSize = parseFloat(computedStyle.fontSize);
                  el.style.fontSize = (currentSize * 1.35) + 'px'; // Increase by 35%
                }
              });
            }
          }
        });

        // Remove wrapper
        document.body.removeChild(wrapper);

        // Create PDF
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = pdfWidth;
        const imgHeight = (canvas.height * pdfWidth) / canvas.width;

        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pdfHeight;

        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pdfHeight;
        }

        pdf.save('Course_Registration_' + new Date().toISOString().split('T')[0] + '.pdf');
      } catch (error) {
        console.error('PDF generation error:', error);
        showAlert('Failed to generate PDF. Please try using the Print button instead.', 'PDF Generation Failed', 'error');
      } finally {
        document.body.removeChild(loadingOverlay);
      }
    };

    window.loadRegistrationView = loadRegistrationView;
    window.registerSingleCourse = registerSingleCourse;

    // Load Evaluate Options (new unified entry point)
    async function loadEvaluateOptions() {
      const container = document.getElementById('evaluateView');
      container.innerHTML = '<div class="card"><h2 class="card-title">Loading...</h2></div>';

      const years = await apiCall('/components_data/academic_year_option_list', 'GET');

      let html = '<div class="card"><h2 class="card-title">Evaluate Lecturers</h2>';
      html += '<p class="card-subtitle">Select academic year and semester</p>';
      
      // Check if 2025/2026 evaluations are available
      html += '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 8px;">';
      html += '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#856404" style="display: inline-block; vertical-align: middle; margin-right: 10px;">';
      html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />';
      html += '</svg>';
      html += '<strong style="color: #856404;">Note:</strong> <span style="color: #856404;">Evaluations for 2025/2026 academic year are not yet available. Please check back later or select a previous year.</span>';
      html += '</div>';
      
      html += '<div class="form-group"><label>Academic Year</label><select id="yearSelectEval" class="form-group input">';

      if (years && years.length > 0) {
        years.forEach(function(year) {
          const selected = year.value === '2024/2025' ? ' selected' : '';
          html += '<option value="' + year.value + '"' + selected + '>' + year.label + '</option>';
        });
      }

      html += '</select></div>';
      html += '<div class="form-group"><label>Semester</label><select id="semesterSelectEval" class="form-group input">';
      html += '<option value="1">Semester 1</option><option value="2">Semester 2</option></select></div>';
      html += '<div class="btn-group">';
      html += '<button class="btn btn-success" id="bypassAllBtn"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>Bypass Evaluation</button>';
      html += '<button class="btn btn-primary" id="evalSelectBtn">Select Specific Courses</button>';
      html += '</div></div>';

      container.innerHTML = html;

      document.getElementById('bypassAllBtn').addEventListener('click', async function() {
        const year = document.getElementById('yearSelectEval').value;
        const semester = document.getElementById('semesterSelectEval').value;
        
        if (year === '2025/2026') {
          showAlert('Evaluations for the 2025/2026 academic year are not yet available. Please select a previous year to evaluate lecturers.', 'Evaluation Not Available', 'info');
          return;
        }
        
        this.disabled = true;
        this.innerHTML = '<div class="spinner"></div><span>Loading...</span>';
        
        const courses = await loadCourses(year, semester);
        
        // Check if token expired (courses will be null)
        if (!courses) {
          this.disabled = false;
          this.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>Bypass Evaluation';
          return;
        }
        
        const unevaluated = courses.filter(function(c) {
          return c.evaluation_status !== '1' && c.evaluation_status !== 1;
        });

        if (unevaluated.length === 0) {
          this.disabled = false;
          this.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>Bypass Evaluation';
          showAllComplete(container, courses, year, semester);
        } else {
          showBypassConfirmDialog(container, unevaluated, year, semester);
        }
      });

      document.getElementById('evalSelectBtn').addEventListener('click', async function() {
        const year = document.getElementById('yearSelectEval').value;
        const semester = document.getElementById('semesterSelectEval').value;
        
        if (year === '2025/2026') {
          showAlert('Evaluations for the 2025/2026 academic year are not yet available. Please select a previous year to evaluate lecturers.', 'Evaluation Not Available', 'info');
          return;
        }
        
        const courses = await loadCourses(year, semester);
        
        // Check if token expired (courses will be null)
        if (!courses) {
          return;
        }
        
        const unevaluated = courses.filter(function(c) {
          return c.evaluation_status !== '1' && c.evaluation_status !== 1;
        });

        if (unevaluated.length === 0) {
          showAllComplete(container, courses, year, semester);
        } else {
          displaySelectableCourses(container, unevaluated, year, semester);
        }
      });
    }

    // Show all complete message
    function showAllComplete(container, courses, year, semester) {
      const evaluated = courses.filter(function(c) { return c.evaluation_status === '1' || c.evaluation_status === 1; }).length;
      
      let html = '<div class="card">';
      html += '<div style="text-align: center; margin-bottom: 30px;">';
      html += '<svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color: var(--success); margin-bottom: 20px;">';
      html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />';
      html += '</svg>';
      html += '<h2 class="card-title">All Evaluations Complete!</h2>';
      html += '<p style="color: var(--gray); margin: 20px 0;">You have successfully completed all lecturer evaluations for ' + year + ' Semester ' + semester + '.</p>';
      html += '</div>';
      html += '<div class="stats-grid">';
      html += '<div class="stat-card"><div class="stat-value">' + courses.length + '</div><div class="stat-label">Total Courses</div></div>';
      html += '<div class="stat-card"><div class="stat-value">' + evaluated + '</div><div class="stat-label">Completed</div></div>';
      html += '</div>';
      html += '<button class="btn btn-primary" onclick="switchView(\'home\')" style="margin-top: 24px;">Back to Home</button></div>';
      
      container.innerHTML = html;
    }

    // Download results as PDF directly
    async function downloadResultsPDF() {
      const element = document.getElementById('printableResults');
      
      if (!element) {
        showAlert('No results available to download. Please try again.', 'Download Failed', 'error');
        return;
      }
      
      // Show animated loading indicator
      const loadingOverlay = document.createElement('div');
      loadingOverlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;';
      loadingOverlay.innerHTML = '<div style="background: white; padding: 40px 50px; border-radius: 16px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);"><div style="width: 60px; height: 60px; border: 4px solid #e0e0e0; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div><p style="color: var(--dark); font-weight: 700; font-size: 18px; margin-bottom: 8px;">Generating PDF...</p><p style="color: var(--gray); font-size: 14px;">Please wait a moment</p></div><style>@keyframes spin { to { transform: rotate(360deg); }}</style>';
      document.body.appendChild(loadingOverlay);
      
      let wrapper = null;
      
      try {
        // Clone the element to avoid modifying the original
        const clonedElement = element.cloneNode(true);
        
        // Create a wrapper with proper styling
        wrapper = document.createElement('div');
        wrapper.style.cssText = 'position: absolute; left: -9999px; top: 0; width: 1200px; padding: 20px; box-sizing: border-box; background: white; opacity: 0; pointer-events: none;';
        wrapper.appendChild(clonedElement);
        
        // Temporarily add to body for html2canvas
        document.body.appendChild(wrapper);
        
        // Use html2canvas to capture the element with higher quality
        const canvas = await html2canvas(wrapper, {
          scale: 3,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff',
          letterRendering: true,
          allowTaint: false,
          foreignObjectRendering: false,
          windowWidth: 1200,
          windowHeight: wrapper.scrollHeight,
          imageTimeout: 0,
          removeContainer: false,
          onclone: function(clonedDoc) {
            const clonedWrapper = clonedDoc.body.querySelector('div');
            if (clonedWrapper) {
              // Ensure colors are preserved and increase font sizes
              const allElements = clonedWrapper.querySelectorAll('*');
              allElements.forEach(function(el) {
                const computedStyle = window.getComputedStyle(el);
                if (computedStyle.color) el.style.color = computedStyle.color;
                if (computedStyle.backgroundColor) el.style.backgroundColor = computedStyle.backgroundColor;
                if (computedStyle.borderColor) el.style.borderColor = computedStyle.borderColor;
                
                // Increase font sizes for better PDF readability
                if (computedStyle.fontSize) {
                  const currentSize = parseFloat(computedStyle.fontSize);
                  el.style.fontSize = (currentSize * 1.35) + 'px'; // Increase by 35%
                }
              });
            }
          }
        });
        
        // Remove the temporary wrapper immediately
        if (wrapper && wrapper.parentNode) {
          document.body.removeChild(wrapper);
          wrapper = null;
        }
        
        const imgData = canvas.toDataURL('image/png', 1.0);
        
        // Create PDF using jsPDF
        const { jsPDF } = window.jspdf;
        
        // Calculate proper dimensions for A4
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4',
          compress: true
        });
        
        let heightLeft = imgHeight;
        let position = 0;
        
        // Add first page with PNG for better color
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, '', 'FAST');
        heightLeft -= pageHeight;
        
        // Add additional pages if needed
        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, '', 'FAST');
          heightLeft -= pageHeight;
        }
        
        // Generate filename with current date
        const filename = 'GCTU_Results_' + new Date().toISOString().split('T')[0] + '.pdf';
        
        // Save the PDF
        pdf.save(filename);
        
        // Remove loading overlay with fade out
        setTimeout(function() {
          loadingOverlay.style.opacity = '0';
          loadingOverlay.style.transition = 'opacity 0.3s';
          setTimeout(function() {
            if (loadingOverlay.parentNode) {
              document.body.removeChild(loadingOverlay);
            }
          }, 300);
        }, 500);
        
      } catch (error) {
        console.error('PDF generation error:', error);
        // Clean up wrapper if it still exists
        if (wrapper && wrapper.parentNode) {
          document.body.removeChild(wrapper);
        }
        if (loadingOverlay.parentNode) {
          document.body.removeChild(loadingOverlay);
        }
        showAlert('Failed to generate PDF. Please try using the Print button instead.', 'PDF Generation Failed', 'error');
      }
    }

    // Show bypass confirmation dialog
    function showBypassConfirmDialog(container, courses, year, semester) {
      // Create modal overlay
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;';
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = 'background: white; border-radius: 16px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s;';
      
      modalContent.innerHTML = `
        <style>
          @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
          @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        </style>
        <div style="text-align: center;">
          <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color: var(--warning); margin-bottom: 20px;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 16px; color: var(--dark);">Bypass Evaluation</h2>
          <p style="color: var(--gray); font-size: 16px; margin-bottom: 12px;">This will mark all <strong>${courses.length} lecturers</strong> as evaluated.</p>
          <p style="color: var(--gray); font-size: 16px; margin-bottom: 30px;">Continue?</p>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="cancelBypass" class="btn btn-secondary" style="min-width: 120px;">No</button>
            <button id="confirmBypass" class="btn btn-success" style="min-width: 120px;">Yes</button>
          </div>
        </div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      document.getElementById('cancelBypass').addEventListener('click', function() {
        document.body.removeChild(modal);
      });
      
      document.getElementById('confirmBypass').addEventListener('click', function() {
        document.body.removeChild(modal);
        bypassAllEvaluations(container, courses, year, semester);
      });
    }

    // Bypass all evaluations
    async function bypassAllEvaluations(container, courses, year, semester) {
      // Show progress
      let html = '<div class="card">';
      html += '<h2 class="card-title">Bypassing Evaluations</h2>';
      html += '<p class="card-subtitle">Please wait while we process...</p>';
      html += '<div style="margin: 40px 0; text-align: center;">';
      html += '<div style="width: 100px; height: 100px; border: 6px solid #e0e0e0; border-top: 6px solid var(--success); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 30px;"></div>';
      html += '<p style="font-size: 18px; font-weight: 600; color: var(--dark); margin-bottom: 10px;">Processing ' + courses.length + ' courses...</p>';
      html += '<p style="color: var(--gray); font-size: 14px;">This may take a moment</p>';
      html += '</div></div>';
      html += '<style>@keyframes spin { to { transform: rotate(360deg); }}</style>';
      
      container.innerHTML = html;
      
      // Load questions
      const questions = await loadQuestions();
      
      if (!questions) {
        console.error('Failed to load questions');
        showBypassResult(container, false, courses.length, 0, courses.length, 'Failed to load evaluation questions');
        return;
      }
      
      console.log('Loaded questions:', questions);
      
      let successCount = 0;
      let failCount = 0;
      let errors = [];
      
      // Process each course
      for (let i = 0; i < courses.length; i++) {
        const course = courses[i];
        
        console.log('Processing course:', course.code, course.title);
        
        // Build evaluation data
        const evaluationData = [];
        
        questions.forEach(function(category) {
          const catData = {
            questions_type: category.questions_type,
            questions: []
          };
          
          category.questions.forEach(function(q) {
            const isLecturerName = q.question.indexOf('name of the lecturer') !== -1 || q.question.indexOf('Provide the name') !== -1;
            const isComment = q.question.indexOf('Mention at least') !== -1 || q.question.indexOf('What factors') !== -1 || q.question.indexOf('What challenges') !== -1 || q.question.indexOf('obstacles') !== -1 || q.question.indexOf('Given another chance') !== -1 || q.question.indexOf('recommendations') !== -1;
            
            let answer = '';
            
            if (isLecturerName) {
              answer = course.staff_fullname || '';
            } else if (isComment) {
              answer = 'Good';
            } else if (q.question.indexOf('level of participation') !== -1 || q.question.indexOf('level of preparation') !== -1) {
              answer = '80%';
            } else if (q.question.indexOf('would you want to have another course') !== -1) {
              answer = 'Yes';
            } else {
              answer = 'Good';
            }
            
            catData.questions.push({
              question_id: q.question_id,
              question: q.question,
              answer: answer
            });
          });
          
          evaluationData.push(catData);
        });
        
        // Submit evaluation
        try {
          // Format: { answers: [...], class_id: "..." }
          const payload = {
            answers: evaluationData,
            class_id: course.class_id
          };
          
          console.log('Submitting payload for', course.code, ':', payload);
          
          const result = await apiCall('/courses/evaluationadd', 'POST', payload);
          
          console.log('Result for', course.code, ':', result);
          
          // Success if we got an evaluation_id back
          if (result && result.evaluation_id) {
            successCount++;
            console.log('âœ… Success for', course.code);
          } else {
            failCount++;
            const errorMsg = result ? (result.error || result.message || 'Unknown error') : 'No response';
            errors.push(course.code + ': ' + errorMsg);
            console.error('âŒ Failed for', course.code, ':', errorMsg);
          }
        } catch (error) {
          failCount++;
          errors.push(course.code + ': ' + error.message);
          console.error('âŒ Error for', course.code, ':', error);
        }
        
        // Small delay to avoid overwhelming the API
        await new Promise(resolve => setTimeout(resolve, 300));
      }
      
      console.log('Final results - Success:', successCount, 'Failed:', failCount);
      
      // Show result
      showBypassResult(container, true, courses.length, successCount, failCount, errors.join('\n'));
    }

    // Show bypass result
    function showBypassResult(container, success, total, successCount, failCount, errorDetails) {
      let html = '<div class="card">';
      html += '<div style="text-align: center; margin-bottom: 30px;">';
      
      if (success && successCount > 0) {
        html += '<svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color: var(--success); margin-bottom: 20px;">';
        html += '<circle cx="12" cy="12" r="10" stroke-width="2"></circle>';
        html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4" />';
        html += '</svg>';
        html += '<h2 class="card-title" style="color: var(--success); margin-bottom: 16px;">Bypassed Successfully!</h2>';
        html += '<p style="color: var(--gray); font-size: 16px; margin-bottom: 30px;">All evaluations have been marked as complete.</p>';
        html += '<div style="background: var(--light); border-radius: 12px; padding: 20px; margin-bottom: 30px; text-align: left;">';
        html += '<p style="font-weight: 600; margin-bottom: 12px; font-size: 16px;">âœ… Verification Required</p>';
        html += '<p style="color: var(--gray); margin-bottom: 16px;">Please verify the evaluations have been recorded:</p>';
        html += '<a href="https://gctusip.gctu.edu.gh" target="_blank" class="btn btn-primary" style="width: 100%; text-decoration: none; display: inline-block; text-align: center;">Open GCTU SIP Portal</a>';
        html += '</div>';
      } else {
        html += '<svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color: var(--danger); margin-bottom: 20px;">';
        html += '<circle cx="12" cy="12" r="10" stroke-width="2"></circle>';
        html += '<line x1="15" y1="9" x2="9" y2="15" stroke-width="2"></line>';
        html += '<line x1="9" y1="9" x2="15" y2="15" stroke-width="2"></line>';
        html += '</svg>';
        html += '<h2 class="card-title" style="color: var(--danger); margin-bottom: 16px;">Bypass Failed</h2>';
        html += '<p style="color: var(--gray); font-size: 16px; margin-bottom: 20px;">Unable to complete the bypass process.</p>';
        if (errorDetails) {
          html += '<div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 8px; text-align: left;">';
          html += '<p style="font-weight: 600; margin-bottom: 8px; color: #856404;">Error Details:</p>';
          html += '<pre style="color: #856404; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; margin: 0;">' + errorDetails + '</pre>';
          html += '</div>';
        }
      }
      
      html += '</div>';
      
      html += '<div class="stats-grid">';
      html += '<div class="stat-card"><div class="stat-value">' + total + '</div><div class="stat-label">Total Courses</div></div>';
      if (success) {
        html += '<div class="stat-card"><div class="stat-value" style="color: var(--success);">' + successCount + '</div><div class="stat-label">Completed</div></div>';
        if (failCount > 0) {
          html += '<div class="stat-card"><div class="stat-value" style="color: var(--danger);">' + failCount + '</div><div class="stat-label">Failed</div></div>';
        }
      }
      html += '</div>';
      
      html += '<button class="btn btn-primary" onclick="switchView(\'home\')" style="margin-top: 24px;">Back to Home</button></div>';
      
      container.innerHTML = html;
    }
  </script>
</body>
</html>
